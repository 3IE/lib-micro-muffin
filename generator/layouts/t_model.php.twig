<?php
abstract class {{ tClassName }} extends \Lib\Models\Deletable
{
  protected static $table_name = '{{ tableName }}';
  protected static $sequence_name = '{{ sequenceName }}';
  protected static $primary_keys = array({{ primaryKey }});

{% for f in fields %}
  protected $_{{ f.getName }} = {{ f.defaultValueToString }};

  public function get{{ f.getCapName }}()
  {
    return $this->_{{ f.getName }};
  }

  public function set{{ f.getCapName }}(${{ f.getName }})
  {
    $this->_objectEdited();
    $this->_{{ f.getName }} = ${{ f.getName }};
  }

{% endfor %}

{% for mto in manyToOne %}
  protected $_{{ mto.getField }} = null;

  private function get{{ mto.getField | capitalize }}()
  {
    return $this->_{{ mto.getField }};
  }

  private function set{{ mto.getField | capitalize }}(${{ mto.getField }})
  {
    $this->_objectEdited();
    $this->_{{ mto.getField }} = ${{ mto.getField }};
  }

{% set className = mto.getTargetTable | capitalize | removeS %}
{% set attrName = mto.getTargetTable | removeS %}
  /** @var {{ className }} */
  protected ${{ attrName }} = null;

  /** @return {{ className }} */
  public function get{{ className }}()
  {
    if (is_null($this->{{ attrName }}))
      $this->{{ attrName }} = {{ className }}::find($this->_{{ mto.getField }});
     return $this->{{ attrName }};
  }

  /** @param {{ className }} ${{ attrName }} */
  public function set{{ className }}(${{ attrName }})
  {
    $this->{{ attrName }} = ${{ attrName }};
    $this->_{{ mto.getField }} = ${{ attrName}}->get{{ mto.getTargetField | capitalize }}();
    $this->_objectEdited();
  }
{% endfor %}

{% for otm in oneToMany %}
{% set className = otm.getTargetTable | capitalize | removeS %}
{% set attribute = otm.getTargetTable ~ 'From' ~ (otm.getCleanField | capitalize) %}
  /** @var {{ className }}[] */
  protected ${{ attribute }} = null;

  /**
   * @param string $order
   * @return {{ className }}[]
   */
  public function get{{ attribute | capitalize }}($order = null)
  {
    if (is_null($this->{{ attribute }}))
    {
      $pdo = \Lib\PDOS::getInstance();
      if (!is_null($order))
        $query = $pdo->prepare('SELECT * FROM {{ otm.getProcedureName }}(' . $this->_{{ otm.getField }} . ') ORDER BY ' . $order);
      else
        $query = $pdo->prepare('SELECT * FROM {{ otm.getProcedureName }}(' . $this->_{{ otm.getField }} . ')');
      $query->execute();

      $results  = $query->fetchAll();
      $objs     = array();
      foreach ($results as $r)
      {
        $obj = new {{ className }}();
        self::hydrate($obj, $r);
        $objs[] = $obj;
      }
      $this->{{ attribute }} = $objs;
    }
    return $this->{{ attribute }};
  }
{% endfor %}

  /**
  {{ find_params }}
   * @return {{ finalClassName }}
   */
  public static function find({{ find_proto }})
  {
    $pdo = \Lib\PDOS::getInstance();
    $query = $pdo->prepare('SELECT * FROM {{ findProcedureName }}({{ find_placeholder }})');

    //Parameters binding
{% for f in pkFields %}
    if (is_string(${{ f.getName }}))
      $query->bindValue(':{{ f.getName }}', ${{ f.getName }}, PDO::PARAM_STR);
    else
      $query->bindValue(':{{ f.getName }}', ${{ f.getName }});
{% endfor %}

    $query->execute();
    {{ find_result }} = $query->fetch();

    if (!is_null({{ find_result }}) && {{ find_checkNull }})
    {
      $output_object = new {{ finalClassName }}();
      self::hydrate($output_object, {{ find_result }});
      return $output_object;
    }
    else
      return null;
  }

  protected function update()
  {
    $sql        = 'UPDATE {{ tableName }} SET ';
    $set        = '';
    $where      = '';
    $attributes = $this->getAttributes(new \ReflectionClass($this));

    foreach ($attributes as $k => $v)
      if (!in_array($k, self::$primary_keys))
        $set .= $k . ' = :'. $k . ', ';

    foreach (self::$primary_keys as $pk)
      $where .= $pk . ' = :' . $pk . ' AND ';

      $where  = substr($where, 0, -5);
      $set    = substr($set, 0, -2);
      $sql   .= $set . ' WHERE ' . $where;

      $pdo = \Lib\PDOS::getInstance();
      $pdo->begintransaction();

      $query = $pdo->prepare($sql);
      foreach($attributes as $k => $v)
        $query->bindValue(':' . $k, $v);
      $query->execute();

      $pdo->commit();
  }

  /**
   * @param string $order
   * @return {{ finalClassName }}[]
   */
  public static function all($order = NULL)
  {
    return parent::all($order);
  }

  /**
   * @param string $where_clause
   * @return {{ finalClassName }}[]
   */
  public static function where($where_clause)
  {
    return parent::where($where_clause);
  }
}